<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <!-- ============================================================ -->
    <!-- 1. ProductScreen: Category Sidebar + LBP footer              -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.ProductScreen" t-inherit="point_of_sale.ProductScreen" t-inherit-mode="extension">

        <!-- A) Inject inventory-category sidebar AFTER the rightpane -->
        <xpath expr="//div[hasclass('rightpane')]" position="after">
            <div t-if="!ui.isSmall" class="lbp-category-sidebar">
                <div class="lbp-category-sidebar-header">Categories</div>
                <div class="lbp-category-list">
                    <button class="lbp-category-btn lbp-category-btn-all"
                            t-att-class="{'active': !this.categoryState.selectedInternalCategId}"
                            t-on-click="() => this.selectInternalCategory(null)">
                        All
                    </button>
                    <t t-foreach="this.internalCategories" t-as="cat" t-key="cat.id">
                        <button class="lbp-category-btn"
                                t-att-class="{'active': this.categoryState.selectedInternalCategId === cat.id}"
                                t-on-click="() => this.selectInternalCategory(cat.id)"
                                t-att-title="cat.name">
                            <t t-esc="cat.name"/>
                        </button>
                    </t>
                </div>
            </div>
        </xpath>

        <!-- B) Replace the product-list rendering to use filteredProductGroups -->
        <xpath expr="//div[hasclass('overflow-y-auto')]" position="replace">
            <div t-if="this.filteredProductGroups.length > 0"
                 class="overflow-y-auto" t-on-scroll="onScroll">
                <div t-foreach="this.filteredProductGroups"
                     t-as="productCateg" t-key="productCateg[0]"
                     class="product-list d-grid gap-1 gap-lg-2 px-2 pt-0 pb-2">
                    <ProductCard
                        t-foreach="productCateg[1]" t-as="product" t-key="product.id"
                        productId="product.id"
                        product="product"
                        class="pos.productViewMode"
                        name="getProductName(product)"
                        color="product.color || product.pos_categ_ids?.at(-1)?.color"
                        imageUrl="pos.config.show_product_images and this.getProductImage(product)"
                        onClick.bind="() => this.addProductToOrder(product)"
                        t-on-mousedown="(event) => this.onMouseDown(event, product)"
                        t-on-mouseup="longPressHandlers.onMouseUp"
                        t-on-touchstart="(event) => this.onTouchStart(product)"
                        t-on-touchend="longPressHandlers.onTouchEnd"
                        productCartQty="this.state.quantityByProductTmplId[product.id]" />
                </div>
            </div>
        </xpath>

        <!-- C) Inject LBP footer bar at bottom of product-screen div -->
        <xpath expr="//div[hasclass('product-screen')]" position="inside">
            <div t-if="this.showLbpFooter"
                 class="lbp-footer-bar d-flex justify-content-between align-items-center px-3 py-2 w-100">
                <span>
                    Rate: <span class="lbp-rate-badge"><t t-esc="this.formattedLbpRate()"/> LBP/$</span>
                </span>
                <span t-if="currentOrder">
                    Total: <strong t-esc="this.env.utils.formatCurrency(currentOrder.priceIncl)"/>
                    | <span class="lbp-total-lbp"><t t-esc="this.lbpTotal"/> LBP</span>
                </span>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 2. OrderDisplay: Append LBP equivalents to Taxes + Total     -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.OrderDisplay" t-inherit="point_of_sale.OrderDisplay" t-inherit-mode="extension">
        <xpath expr="//span[hasclass('tax')]" position="after">
            <span t-if="order.config_id.display_lbp_total"
                  class="lbp-amount ms-1" style="font-size: 0.8rem;">
                | <t t-esc="this.formatLbpAmount(order.amountTaxes)"/> LBP
            </span>
        </xpath>
        <xpath expr="//span[hasclass('total')]" position="after">
            <span t-if="order.config_id.display_lbp_total"
                 class="lbp-amount ms-1" style="font-size: 0.85rem;">
                | <t t-esc="this.formatLbpAmount(order.priceIncl)"/> LBP
            </span>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 3. Orderline: Append LBP subtotal on its own line            -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.Orderline" t-inherit="point_of_sale.Orderline" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('product-price')]" position="after">
            <div t-if="line.order_id.config_id.display_lbp_total and !line.combo_parent_id"
                 class="lbp-amount text-end"
                 style="font-size: 0.7rem; line-height: 1.1;">
                <t t-esc="this.getLineLbp()"/> LBP
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 4. ProductCard: Dual-pricing (USD + LBP) below name         -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.ProductCard" t-inherit="point_of_sale.ProductCard" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('product-name')]" position="after">
             <div class="lbp-product-price w-100 lh-sm mt-1">
                <div class="fw-semibold" t-esc="this.formattedUsdPrice"/>
                <div t-if="this.showLbpPrice"
                      class="lbp-amount"
                      style="font-size: 0.78em;"
                      t-esc="this.formattedLbpPrice"/>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 5. PaymentScreenDue — LBP total due display                  -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.PaymentScreenDue" t-inherit="point_of_sale.PaymentScreenDue" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('total')]" position="inside">
            <div t-if="this.showLbp" class="lbp-total-due">
                <t t-esc="this.lbpTotalDue"/> LBP
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 6. PaymentScreen — LBP info bar when Cash LBP is selected    -->
    <!--    Shows raw LBP being typed + USD equivalent in real time    -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.PaymentScreen" t-inherit="point_of_sale.PaymentScreen" t-inherit-mode="extension">
        <xpath expr="//Numpad" position="before">
            <div t-if="this.showLbp and this.isLbpLineSelected"
                 class="lbp-info-bar">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fa fa-money me-1"/>
                        <strong>Typing LBP</strong>
                    </span>
                    <span class="text-muted" style="font-size:0.8rem;">
                        Rate: <t t-esc="this.formattedLbpRate"/> LBP/$
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-baseline mt-1">
                    <span class="lbp-info-amount">
                        <t t-esc="this.currentLbpInputFormatted"/> LBP
                    </span>
                    <span class="text-muted">
                        = $<t t-esc="this.currentLbpInputUsd"/>
                    </span>
                </div>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 7. PaymentScreenMethods — Grid layout, all visible, no scroll-->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.PaymentScreenMethods" t-inherit="point_of_sale.PaymentScreenMethods" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('paymentmethods')]" position="replace">
            <div class="paymentmethods lbp-payment-methods-grid">
                <t t-foreach="payment_methods_from_config" t-as="paymentMethod" t-key="paymentMethod.id">
                    <div t-if="!(this.pos.cashier._role === 'minimal' and paymentMethod.type === 'pay_later')"
                         class="lbp-payment-method-btn"
                         t-on-click="() => this.addNewPaymentLine(paymentMethod)">
                        <img class="payment-method-icon mb-1" t-att-src="paymentMethodImage(paymentMethod.id)"
                             style="height: 22px; object-fit: contain;"/>
                        <span class="payment-name fw-bold"><t t-esc="paymentMethod.name"/></span>
                        <span class="text-muted" style="font-size:0.75rem;"
                              t-esc="pos.getPaymentMethodFmtAmount(paymentMethod, currentOrder)"/>
                    </div>
                </t>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 8. PaymentScreenPaymentLines — LBP appended per line         -->
    <!-- We use a JS patch on PaymentLines component instead (below)  -->
    <!-- ============================================================ -->


    <!-- ============================================================ -->
    <!-- 9. PaymentScreenStatus — LBP remaining / change              -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.PaymentScreenStatus" t-inherit="point_of_sale.PaymentScreenStatus" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('payment-status-amount')]" position="after">
            <div t-if="this.showLbp"
                 class="lbp-amount text-center mt-1"
                 style="font-size: 0.8rem; font-weight: 600;">
                <t t-if="this.isChange">Change: <t t-esc="this.lbpRemainingOrChange"/> LBP</t>
                <t t-else="">Remaining: <t t-esc="this.lbpRemainingOrChange"/> LBP</t>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 10. ClosePosPopup — LBP summary block after methods overview  -->
    <!-- Rate banner + separate LBP total per payment method           -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.ClosePosPopup" t-inherit="point_of_sale.ClosePosPopup" t-inherit-mode="extension">

        <!-- Rate in header -->
        <xpath expr="//div[hasclass('total-orders')]" position="after">
            <div t-if="this.showLbp"
                 class="lbp-amount fw-bold ms-3" style="font-size: 0.85em; align-self: center;">
                1 USD = <t t-esc="this.formatLbpAmount(1)"/> LBP
            </div>
        </xpath>

        <!-- LBP summary block injected after the payment-methods-overview -->
        <xpath expr="//div[hasclass('payment-methods-overview')]" position="after">
            <div t-if="this.showLbp" class="lbp-closing-summary">
                <div class="lbp-closing-summary-title">LBP Equivalents</div>
                <!-- Cash default -->
                <div t-if="pos.config.cash_control"
                     class="d-flex justify-content-between">
                    <span><t t-esc="props.default_cash_details.name"/></span>
                    <span class="lbp-amount fw-bold">
                        <t t-esc="this.formatLbpAmount(props.default_cash_details.amount)"/> LBP
                    </span>
                </div>
                <!-- Non-cash methods -->
                <t t-foreach="props.non_cash_payment_methods" t-as="pm" t-key="pm.id">
                    <div class="d-flex justify-content-between">
                        <span><t t-esc="pm.name"/></span>
                        <span class="lbp-amount fw-bold">
                            <t t-esc="this.formatLbpAmount(pm.amount)"/> LBP
                        </span>
                    </div>
                </t>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 11. MoneyDetailsPopup — LBP per denomination in Coins/Notes  -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.MoneyDetailsPopup" t-inherit="point_of_sale.MoneyDetailsPopup" t-inherit-mode="extension">

        <!-- Add LBP equivalent next to each bill/coin denomination label -->
        <xpath expr="//span[hasclass('ms-1')]" position="after">
            <span t-if="pos.config.display_lbp_total"
                  class="lbp-amount d-block" style="font-size: 0.72rem; line-height: 1.2;">
                <t t-esc="Math.round(_parseFloat(moneyValue) * (pos.config.lbp_usd_rate || 89500)).toLocaleString('en-US')"/> LBP
            </span>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 12. OrderReceipt — LBP on total, change, rate at bottom      -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.OrderReceipt" t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension">

        <xpath expr="//div[hasclass('receipt-total')]" position="after">
            <div t-if="this.showLbp" class="lbp-receipt-total">
                <t t-esc="this.formatLbpAmount(order.priceIncl)"/> LBP
            </div>
        </xpath>

        <xpath expr="//div[hasclass('receipt-change')]" position="after">
            <div t-if="this.showLbp and order.showChange" class="lbp-receipt-line">
                Change: <t t-esc="this.formatLbpAmount(order.change)"/> LBP
            </div>
        </xpath>

        <xpath expr="//div[hasclass('before-footer')]" position="before">
            <div t-if="this.showLbp" class="lbp-receipt-rate">
                Rate: 1 USD = <t t-esc="this.formatLbpAmount(1)"/> LBP
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 13. ReceiptScreen — WhatsApp button + LBP in banner          -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.ReceiptScreen" t-inherit="point_of_sale.ReceiptScreen" t-inherit-mode="extension">

        <xpath expr="//span[hasclass('edit-order-payment')]" position="before">
            <span t-if="this.showLbp" class="lbp-amount" style="font-size: 0.8em;">
                | <t t-esc="this.lbpOrderAmount"/> LBP
            </span>
        </xpath>

        <xpath expr="//input[hasclass('send-receipt-email-input')]/.." position="after">
            <div class="d-flex mt-2">
                <input type="tel"
                       class="send-receipt-whatsapp-input o_input position-relative p-3 border border-end-0 rounded-start-2 text-body"
                       placeholder="e.g. +961 71 123 456"
                       t-model="this.lbpState.whatsappPhone"/>
                <div>
                    <button t-att-style="`width: ${this.ui.isSmall ? '4rem' : '8rem'}`"
                            class="btn btn-success btn-lg lh-lg rounded-start-0 h-100"
                            t-att-disabled="!this.isValidWhatsApp"
                            t-on-click="() => this.sendViaWhatsApp()">
                        <i class="fa fa-whatsapp"/>
                    </button>
                </div>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 14. LoginScreen — Username/Password                          -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.LoginScreen" t-inherit="point_of_sale.LoginScreen" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('login-body')]" position="replace">
            <div class="login-body login-form d-flex flex-column gap-3 m-auto" style="max-width: 400px; width: 100%;">
                <div class="text-center mb-3">
                    <h4>POS Login</h4>
                </div>
                <input type="text"
                       class="form-control form-control-lg rounded-3 p-3"
                       placeholder="Username"
                       t-model="this.loginState.username"
                       t-on-keydown="(ev) => this.onUsernameKeydown(ev)"
                       t-att-disabled="this.loginState.isLoading"/>
                <input type="password"
                       class="form-control form-control-lg rounded-3 p-3"
                       placeholder="Password"
                       t-model="this.loginState.password"
                       t-on-keydown="(ev) => this.onPasswordKeydown(ev)"
                       t-att-disabled="this.loginState.isLoading"/>
                <button class="btn btn-primary btn-lg py-3 rounded-3 fw-bold"
                        t-on-click="() => this.openRegister()"
                        t-att-disabled="this.loginState.isLoading">
                    <i t-if="this.loginState.isLoading" class="fa fa-spin fa-circle-o-notch me-2"/>
                    <i t-else="" class="fa fa-sign-in me-2"/>
                    <span t-if="this.loginState.isLoading">Logging in...</span>
                    <span t-else="">Open Register</span>
                </button>
            </div>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 15. ProductInfoPopup — LBP on price fields                   -->
    <!-- ============================================================ -->
    <t t-name="pos_lebanon_custom.ProductInfoPopup" t-inherit="point_of_sale.ProductInfoPopup" t-inherit-mode="extension">
        <xpath expr="//label[contains(text(),'Price excl. Tax')]/../span" position="after">
            <span t-if="this.showLbp" class="lbp-amount ms-1" style="font-size: 0.85em;">
                | <t t-esc="this.formatLbpAmount(props.info.productInfo.all_prices.price_without_tax)"/> LBP
            </span>
        </xpath>
        <xpath expr="//label[contains(text(),'Price incl. Tax')]/../span" position="after">
            <span t-if="this.showLbp" class="lbp-amount ms-1" style="font-size: 0.85em;">
                | <t t-esc="this.formatLbpAmount(props.info.productInfo.all_prices.price_with_tax)"/> LBP
            </span>
        </xpath>
    </t>


    <!-- ============================================================ -->
    <!-- 16. ProductConfiguratorPopup — LBP via JS patch              -->
    <!-- ============================================================ -->

</templates>
